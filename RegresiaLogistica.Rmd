---
title: "Proiect-Clasificarea_apei"
output: html_notebook
---

Importarea librariilor necesare
```{r}
#install.packages("rlang")
#library(rlang)
#install.packages("tidyverse")
#install.packages("tree")
#install.packages("rpart
#install.packages("rpart.plot")
#install.packages("ISLR")
#install.packages("ipred")
#install.packages("randomForest")
#install.packages("ranger")
#install.packages("partykit")
#install.packages("caret")

library(partykit)
library(tidyverse)
library(modelr)
library(caret)
library(rsample)
library(corrplot)
library(dplyr)
library(magrittr)
library(corrplot)
library(tree)
library(rpart)
library(rpart.plot)
library(ISLR)
library(ipred)
library(randomForest)
library(ranger)
library(pROC)
library(partykit)
```


Incarcarea bazei de date
```{r}
water <- read.csv("water_quality.csv")
data(water)
View(water)
summary(water)
```



Curățarea datelor

Convertim atributul ammonia din caracter in numeric (chr to dbl).
```{r}
water$ammonia <- as.numeric(water$ammonia)
```

Eliminăm eventualele observații care conțin valori lipsă si redenumim variabila dependenta.
```{r}
(water <- drop_na(water) %>%
  rename(potability = is_safe))
```



Transformăm atributul potability in factor:
```{r}
water <- water %>% 
  mutate(potability = ifelse(potability == 0, "No", "Yes"))
water <- water %>% mutate(potability = factor(potability))
table(water$potability)
```




---VIZUALIZAREA DATELOR---

Am construit un grafic de puncte dupa proprietati si am observat ca nu e relevant, deoarece majoritatea datelor sunt concentrate in zona de mijloc.

#TODO change variables 
```{r}
water %>% ggplot(aes(x=silver,y=perchlorate,color=potability))+
  geom_point()
water %>% ggplot(aes(x=aluminium,y=cadmium,color=potability))+
  geom_point()
water %>% ggplot(aes(x=aluminium,y=barium,color=potability))+
  geom_point()
```

Grupam datele dupa variabila tinta Potabilitate. Observam ca avem mai multe date pentru valoarea 0, deci mai multe date pentru apa nepotabila.
```{r}
by_potability <- group_by(water, potability)
summarize(by_potability, count=n())
```




```{r}

water %>% group_by(potability) %>%
  summarize_all(~mean(.)) %>%
  ungroup() %>%
  #restructuram dataset - in afara de potability, preluam toate col, names_to preia de pe coloane, values_to preia din celule
  pivot_longer(!potability, names_to = "features", values_to = "min") %>%
  #cream graficul pe orizontala prop, pe vert valori min)
  ggplot(aes(features, min, fill = potability)) +
  #design-ul graficului
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~features, scales = "free")
```
Rezultatul obtinut poate fi interpretat astfel: in cadrul chloraminelor, duritatii, carbonului si a sulfatilor, valorile minime sunt mult mai ridicate in cazul apei nepotabile; in contrast, valorile minime ale conductivitatii, solidelor, trihalometanului si turbiditatii sunt mai ridicate pentru apa potabila; ph-ul prezinta un caz aparte, deoarce prezinta valori doar in cazul apei potabile, apa potabila avand mereu un caracter bazic, adica un ph pozitiv.


```{r}
water %>%
  filter(potability == "Yes") %>%
  select_if(is.numeric) %>%
  gather(metric, value) %>%
  ggplot(aes(value, fill=metric)) +
  geom_density(show.legend = FALSE) +
  facet_wrap(~metric, scales = "free")
```
```{r}
water %>%
  ggplot(aes(cadmium))+geom_density()
```



```{r}
correlations <- cor(water[,1:20])
# create correlation plot
corrplot(correlations, method="circle")
```




---ÎMPĂRȚIREA DATELOR---

```{r}
#
set.seed(123)
split <- initial_split(water, prop=0.7, strata= "potability")
train <-training(split)
test <- testing(split)

features <- setdiff(names(train), "potability")
x <- train[,features]
y <- train$potability

train_control <- trainControl(
  method="cv",
  number=10
)
```





---LOGISTOC REGRESSION---

Generarea unui model in functie de proprietati.
```{r}
model_al<-glm(data=water, potability ~ aluminium, family=binomial)
summary(model_al) #<2e 0.574

model_am<-glm(data=water, potability ~ ammonia, family=binomial)
summary(model_am)#0.045, coef -

model_ar<-glm(data=water, potability ~ arsenic, family=binomial)
summary(model_ar)#<2e, coef -

model_br<-glm(data=water, potability ~ barium, family=binomial)
summary(model_br)#7.62e

model_cd<-glm(data=water, potability ~ cadmium, family=binomial)
summary(model_cd)#<2e, coef -

model_cl<-glm(data=water, potability ~ chloramine, family=binomial)
summary(model_cl)#<2e

model_cr<-glm(data=water, potability ~ chromium, family=binomial)
summary(model_cr)#<2e, coef mare 1.84

model_cp<-glm(data=water, potability ~ copper, family=binomial)
summary(model_cp)#0.0084 0.14

model_fl<-glm(data=water, potability ~ flouride, family=binomial)
summary(model_fl)# p mare

model_bc<-glm(data=water, potability ~ bacteria, family=binomial)
summary(model_bc)#0.0485 coef -

model_vs<-glm(data=water, potability ~ viruses, family=binomial)
summary(model_vs)#p mic, coef negativ

model_ld<-glm(data=water, potability ~ lead, family=binomial)
summary(model_ld)# coef - p mare

model_na<-glm(data=water, potability ~ nitrates, family=binomial)
summary(model_na)#p 1.393e coef neagtiv

model_ni<-glm(data=water, potability ~ nitrites, family=binomial)
summary(model_ni)#coef poz, p mic 2.74e

model_mc<-glm(data=water, potability ~ mercury, family=binomial)
summary(model_mc)#foarte mic beta, p doua stele

model_pc<-glm(data=water, potability ~ perchlorate, family=binomial)
summary(model_pc)#p 1.71e-11 coef 0.012

model_rd<-glm(data=water, potability ~ radium, family=binomial)
summary(model_rd)#p 8.11e-09 coef 0.08

model_sl<-glm(data=water, potability ~ selenium, family=binomial)
summary(model_sl)#coef -, p 2 stele

model_sv<-glm(data=water, potability ~ silver, family=binomial)
summary(model_sv)#coef 2.044 p mic <2e-16

model_ur<-glm(data=water, potability ~ uranium, family=binomial)
summary(model_ur)#coef -, p 1.72e-11
```
Observând rezultatele obținute, am descoperit faptul ca variabilele sunt relevante, mai putin florul, care are o valoare mare a lui p. 


Crearea modelelor pe date specifice
--Primul model creat pe toate variabilele 
```{r}
(model_final <- glm(data=train, potability~aluminium+barium+chloramine+chromium+silver+copper+nitrites+perchlorate+radium+ammonia+arsenic+cadmium+bacteria+viruses+lead+nitrates+mercury+selenium+uranium+flouride, family=binomial))

```
Observam faptul ca proprietatea aluminium este cea mai seminificativa, deoarece inregistreaza cea mai mica valoare a lui p, <2e-16. 


```{r}
pred_test <- predict(model_final, newdata=test, type="response")
table(pred_test > 0.3, test$potability)
```
```{r}
pred_mx <- predict(model_final, newdata=test)
(conf1 <- confusionMatrix(factor(ifelse(pred_mx>0.3, "Yes", "No")), factor(test$potability)))

```

--Modelul 2 s-a realizat pe variabilele independente cu o relatie directa cu variabila dependenta
```{r}
model_2 <- glm(data=train, potability~aluminium+barium+chloramine+chromium+copper, family=binomial)
summary(model_2)

pred_test_2 <- predict(model_2, newdata=test, type="response")
table(pred_test_2 > 0.3, test$potability)

(conf2 <- confusionMatrix(factor(ifelse(pred_test_2>0.3, "Yes", "No")), factor(test$potability)))
```


--Modelul 3 s-a realizat pe variabilele independente cu o relatie indirecta cu variabila dependenta
```{r}
model_3 <- glm(data=train, potability~arsenic+cadmium+mercury+selenium+uranium, family=binomial)
summary(model_3)

pred_test_3 <- predict(model_3, newdata=test, type="response")
table(pred_test_3 > 0.3, test$potability)

(conf3 <- confusionMatrix(factor(ifelse(pred_test_3>0.3, "Yes", "No")), factor(test$potability)))
```


Cross-validation
```{r}
model_cv_lr  <- train (
  x=x,
  y=y,
  method="glm",
  family="binomial",
  trControl = train_control
)
model_cv_lr
pred_cv_lr = predict (model_cv_lr, newdata=test, type="raw")
conf4 <- confusionMatrix(pred_cv_lr, test$potability)
summary(model_cv_lr)

```



Tabel comparativ 
```{r}

model <- c('model_final','model_2','model_3', 'model_cv_lr')
accuracy <- c(conf1$overall['Accuracy'], conf2$overall['Accuracy'], conf3$overall['Accuracy'], conf4$overall['Accuracy'])
sensitivity <- c(conf1$byClass['Sensitivity'], conf2$byClass['Sensitivity'], conf3$byClass['Sensitivity'], conf4$byClass['Sensitivity'])
specificity <- c(conf1$byClass['Specificity'], conf2$byClass['Specificity'], conf3$byClass['Specificity'], conf4$byClass['Specificity'])
performance <- data.frame(model, accuracy, sensitivity, specificity)
performance
```







