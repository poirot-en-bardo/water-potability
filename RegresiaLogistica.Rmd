---
title: "Proiect-Clasificarea_apei"
output: html_notebook
---

Importarea librariilor necesare
```{r}
#install.packages("rlang")
#library(rlang)
#install.packages("tidyverse")
library(tidyverse)
library(modelr)
library(caret)
library(rsample)
library(corrplot)
library(dplyr)
library(magrittr)
library(corrplot)
library(tree)
library(rpart)
library(rpart.plot)
library(ISLR)
library(ipred)
library(randomForest)
library(ranger)
library(pROC)
library(partykit)
```


Incarcarea bazei de date
```{r}
water <- read.csv("water_quality.csv")
data(water)
View(water)
summary(water)
```



Curățarea datelor

Convertim atributul ammonia din caracter in numeric (chr to dbl).
```{r}
water$ammonia <- as.numeric(water$ammonia)
```

Eliminăm eventualele observații care conțin valori lipsă si redenumim variabila dependenta.
```{r}
(water <- drop_na(water) %>%
  rename(potability = is_safe))
```



Transformăm atributul potability in factor:
```{r}
water <- water %>% 
  mutate(potability = ifelse(potability == 0, "No", "Yes"))
water <- water %>% mutate(potability = factor(potability))
table(water$potability)
```




---VIZUALIZAREA DATELOR---

Am construit un grafic de puncte dupa proprietati si am observat ca nu e relevant, deoarece majoritatea datelor sunt concentrate in zona de mijloc.

#TODO change variables 
```{r}
water %>% ggplot(aes(x=silver,y=perchlorate,color=potability))+
  geom_point()
water %>% ggplot(aes(x=arsenic,y=cadmium,color=potability))+
  geom_point()
water %>% ggplot(aes(x=aluminium,y=ammonia,color=potability))+
  geom_point()
```

Grupam datele dupa variabila tinta Potabilitate. Observam ca avem mai multe date pentru valoarea 0, deci mai multe date pentru apa nepotabila.
```{r}
by_potability <- group_by(water, potability)
summarize(by_potability, count=n())
```


Dorim sa vizualizam diferentele dintre variabile si care este legatura dintre cu variabila tinta, astfel ca afisam un grafic ce ilustreaza situatia pentru fiecare proprietate a apei in parte. Am utilizat valorile minime pentru fiecare variabila ca si termen de comparatie.

```{r}

water %>% group_by(potability) %>%
  summarize_all(~mean(.)) %>%
  ungroup() %>%
  #restructuram dataset - in afara de potability, preluam toate col, names_to preia de pe coloane, values_to preia din celule
  pivot_longer(!potability, names_to = "features", values_to = "min") %>%
  #cream graficul pe orizontala prop, pe vert valori min)
  ggplot(aes(features, min, fill = potability)) +
  #design-ul graficului
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~features, scales = "free")
```
Rezultatul obtinut poate fi interpretat astfel: in cadrul chloraminelor, duritatii, carbonului si a sulfatilor, valorile minime sunt mult mai ridicate in cazul apei nepotabile; in contrast, valorile minime ale conductivitatii, solidelor, trihalometanului si turbiditatii sunt mai ridicate pentru apa potabila; ph-ul prezinta un caz aparte, deoarce prezinta valori doar in cazul apei potabile, apa potabila avand mereu un caracter bazic, adica un ph pozitiv.


```{r}
water %>%
  filter(potability == "Yes") %>%
  select_if(is.numeric) %>%
  gather(metric, value) %>%
  ggplot(aes(value, fill=metric)) +
  geom_density(show.legend = FALSE) +
  facet_wrap(~metric, scales = "free")
```
```{r}
water %>%
  ggplot(aes(cadmium))+geom_density()
```



```{r}
correlations <- cor(water[,1:20])
# create correlation plot
corrplot(correlations, method="circle")
```




---ÎMPĂRȚIREA DATELOR---

```{r}
#
set.seed(123)
split <- initial_split(water, prop=0.7, strata= "potability")
train <-training(split)
test <- testing(split)
```





---ANALIZA DATELOR---


Generarea unui model in functie de toate proprietatile.
```{r}
(model_all <- glm(data=water_f, potability~ph+Hardness+Solids+Chloramines+Sulfate+Conductivity+Organic_carbon+Trihalomethanes+Turbidity, family=binomial))
summary(model_all)
```

Generarea unui model in functie de proprietati.
```{r}
model_ph<-glm(data=water, potability ~ ph, family=binomial)
summary(model_ph)

model_hard<-glm(data=water, potability ~ Hardness, family=binomial)
summary(model_hard)

model_sol<-glm(data=water, potability ~ Solids, family=binomial)
summary(model_sol)

model_ch<-glm(data=water, potability ~ Chloramines, family=binomial)
summary(model_ch)

model_sulf<-glm(data=water, potability ~ Sulfate, family=binomial)
summary(model_sulf)

model_cond<-glm(data=water, potability ~ Conductivity, family=binomial)
summary(model_cond)

model_org<-glm(data=water, potability ~ Organic_carbon, family=binomial)
summary(model_org)

model_thr<-glm(data=water, potability ~ Trihalomethanes, family=binomial)
summary(model_thr)

model_trb<-glm(data=water, potability ~ Turbidity, family=binomial)
summary(model_trb)

```
Observam faptul ca valoarea lui p este destul de mare in fiecare din cazuri, ceea ce inseamna ca asocierea dintre variabila si variabila tinta nu este una seminificativa. Alegem insa spre analiza primele 3 cele mai mici valori ale lui p, si anume proprietatile Solids (p=0.0536), Organic_carbon (p=0.0861) si Chloraminele(p=0.174).


Realizam modelul pentru cele 3 variabile alese.
```{r}
(model_final <- glm(data=train, potability~Solids+Organic_carbon+Chloramines, family=binomial))
summary(model_final)
```
Observam faptul ca proprietatea Solids este cea mai seminificativa, deoarece inregistreaza cea mai mica valoare a lui p de 0.0617. 


```{r}
(pred_test <- predict(model_final, newdata=test, type="response"))
table(pred_test > 0.5, test$potability)
```




1.SOLIDS
Valoarea minima si maxima
```{r}
range(water$Solids)
```

```{r}
grid <- water %>%
  data_grid(Solids = seq_range(Solids, 100)) %>%
  add_predictions(model_sol, "prob_default", type="response")
```
```{r}
ggplot()+
  geom_line(data=grid, aes(Solids, prob_default),color="red")
```
```{r}
(nd <- tribble(~Solids, 1000,2000))
(predicted <- predict(model_sol, newdata=nd, type="response"))
```






Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
